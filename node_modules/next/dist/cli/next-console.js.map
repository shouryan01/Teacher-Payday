{"version":3,"sources":["../../cli/next-console.ts"],"sourcesContent":["import { watch } from 'chokidar'\nimport fs from 'fs'\nimport os from 'os'\nimport path from 'path'\nimport * as REPL from 'repl'\nimport { REPLCommand, REPLServer } from 'repl'\nconst debug = require('debug')('blitz:repl')\nimport globby from 'globby'\nimport ProgressBar from 'progress'\nimport { getProjectRootSync } from '../server/lib/utils'\nimport { baseLogger } from '../server/lib/logging'\n\nconst projectRoot = getProjectRootSync()\nconst isTypeScript = fs.existsSync(path.join(projectRoot, 'tsconfig.json'))\n\nconst invalidateCache = (module: string) => {\n  delete require.cache[require.resolve(module)]\n}\n\nexport const forceRequire = (modulePath: string) => {\n  invalidateCache(modulePath)\n\n  if (isTypeScript) {\n    return require(modulePath)\n  } else {\n    const esmRequire = require('esm')(module)\n    return esmRequire(modulePath)\n  }\n}\n\nexport async function getBlitzModulePaths() {\n  // eslint-disable-next-line no-shadow\n  const projectRoot = require('next/dist/server/lib/utils').getProjectRootSync()\n\n  const paths = await globby(\n    [\n      'app/**/{queries,mutations}/**/*.{js,ts,tsx}',\n      'utils/*.{js,ts,tsx}',\n      'jobs/**/*.{js,ts,tsx}',\n      'integrations/**/*.{js,ts,tsx}',\n      '!**/*.test.*',\n      '!**/*.spec.*',\n    ],\n    { cwd: projectRoot, gitignore: true }\n  )\n  paths.push('db')\n  debug('Paths', paths)\n\n  return [...paths.map((p) => path.join(projectRoot, p))]\n}\n\nexport const loadBlitz = async () => {\n  const paths = await getBlitzModulePaths()\n\n  const percentage = new ProgressBar('Loading Modules :current/:total', {\n    total: paths.length,\n  })\n\n  const modules: Record<string, any>[] = Object.assign(\n    {},\n    ...paths.map((modulePath) => {\n      let name = path.parse(modulePath).name\n      if (name === 'index') {\n        const dirs = path.dirname(modulePath).split(path.sep)\n        name = dirs[dirs.length - 1]\n      }\n\n      try {\n        debug('Loading', modulePath)\n        const module = forceRequire(modulePath)\n        const contextObj = module.default || module\n        // debug(\"ContextObj\", contextObj)\n\n        percentage.tick()\n\n        //TODO: include all exports here, not just default\n        return {\n          [name]: contextObj,\n        }\n      } catch (error) {\n        baseLogger().error(`Failed to load ${modulePath}: ${error}`)\n        debug('Failed to load module', error)\n        return {}\n      }\n    })\n  )\n\n  percentage.terminate()\n\n  return modules\n}\n\nconst loadBlitzModules = (repl: REPLServer, modules: any) => {\n  Object.assign(repl.context, modules)\n}\n\nconst loadModules = async (repl: REPLServer) => {\n  loadBlitzModules(repl, await loadBlitz())\n}\n\nconst commands = {\n  reload: {\n    help: 'Reload all modules',\n    async action(this: REPLServer) {\n      this.clearBufferedCommand()\n      console.log('Reloading all modules...')\n      await loadModules(this)\n      this.displayPrompt()\n    },\n  },\n}\n\nconst defineCommands = (\n  repl: REPLServer,\n  // eslint-disable-next-line no-shadow\n  commands: Record<string, REPLCommand>\n) => {\n  Object.entries(commands).forEach(([keyword, cmd]) =>\n    repl.defineCommand(keyword, cmd)\n  )\n}\n\n// eslint-disable-next-line no-shadow\nconst setupSelfRolledHistory = (repl: any, path: string) => {\n  function init() {\n    try {\n      const history = fs.readFileSync(path, { encoding: 'utf8' })\n      const nonEmptyLines = history.split(os.EOL).filter((line) => line.trim())\n      repl.history.push(...nonEmptyLines.reverse())\n    } catch (err: any) {\n      if (err.code !== 'ENOENT') {\n        throw err\n      }\n    }\n  }\n\n  function onExit() {\n    const addedHistory = repl.lines.join(os.EOL)\n    fs.appendFileSync(path, addedHistory)\n  }\n\n  init()\n  repl.on('exit', onExit)\n}\n\nconst setupHistory = (repl: any) => {\n  const blitzConsoleHistoryPath = path.join(\n    projectRoot,\n    '.blitz-console-history'\n  )\n  if (repl.setupHistory) {\n    repl.setupHistory(blitzConsoleHistoryPath, () => {})\n  } else {\n    setupSelfRolledHistory(repl, blitzConsoleHistoryPath)\n  }\n}\n\nconst initializeRepl = async (replOptions: REPL.ReplOptions) => {\n  debug('initializeRepl')\n  const modules = await loadBlitz()\n\n  debug('Starting REPL...')\n  const repl = REPL.start(replOptions)\n\n  loadBlitzModules(repl, modules)\n  defineCommands(repl, commands)\n  setupHistory(repl)\n\n  return repl\n}\n\nconst setupFileWatchers = async (repl: REPLServer) => {\n  debug('Setting up file watchers...')\n  const watchers = [\n    watch(await getBlitzModulePaths(), {\n      ignoreInitial: true,\n    }).on('all', () => loadModules(repl)),\n  ]\n\n  repl.on('reset', async () => {\n    debug('Reset, so reloading modules...')\n    await loadModules(repl)\n  })\n  repl.on('exit', () => watchers.forEach((watcher) => watcher.close()))\n}\n\nconst runRepl = async (replOptions: REPL.ReplOptions) => {\n  const repl = await initializeRepl(replOptions)\n  repl.on('exit', () => process.exit())\n  await setupFileWatchers(repl)\n}\n\nexport { runRepl }\n"],"names":[],"mappings":";;;;QA8BsB,mBAAmB,GAAnB,mBAAmB;;AA9BnB,GAAU,CAAV,SAAU;AACjB,GAAI,CAAJ,GAAI;AACJ,GAAI,CAAJ,GAAI;AACF,GAAM,CAAN,KAAM;AACX,GAAI,CAAJ,IAAI;AAGG,GAAQ,CAAR,OAAQ;AACH,GAAU,CAAV,SAAU;AACC,GAAqB,CAArB,MAAqB;AAC7B,GAAuB,CAAvB,QAAuB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAJlD,KAAK,CAAC,KAAK,GAAG,OAAO,EAAC,KAAO,IAAE,UAAY;AAM3C,KAAK,CAAC,WAAW,OAHkB,MAAqB;AAIxD,KAAK,CAAC,YAAY,GAZH,GAAI,SAYK,UAAU,CAVjB,KAAM,SAUiB,IAAI,CAAC,WAAW,GAAE,aAAe;AAEzE,KAAK,CAAC,eAAe,IAAI,MAAc,GAAK,CAAC;WACpC,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM;AAC7C,CAAC;AAEM,KAAK,CAAC,YAAY,IAAI,UAAkB,GAAK,CAAC;IACnD,eAAe,CAAC,UAAU;IAE1B,EAAE,EAAE,YAAY,EAAE,CAAC;eACV,OAAO,CAAC,UAAU;IAC3B,CAAC,MAAM,CAAC;QACN,KAAK,CAAC,UAAU,GAAG,OAAO,EAAC,GAAK,GAAE,MAAM;eACjC,UAAU,CAAC,UAAU;IAC9B,CAAC;AACH,CAAC;QATY,YAAY,GAAZ,YAAY;eAWH,mBAAmB,GAAG,CAAC;IAC3C,EAAqC,AAArC,mCAAqC;IACrC,KAAK,CAAC,YAAW,GAAG,OAAO,EAAC,0BAA4B,GAAE,kBAAkB;IAE5E,KAAK,CAAC,KAAK,aA3BM,OAAQ;SA6BrB,2CAA6C;SAC7C,mBAAqB;SACrB,qBAAuB;SACvB,6BAA+B;SAC/B,YAAc;SACd,YAAc;;QAEd,GAAG,EAAE,YAAW;QAAE,SAAS,EAAE,IAAI;;IAErC,KAAK,CAAC,IAAI,EAAC,EAAI;IACf,KAAK,EAAC,KAAO,GAAE,KAAK;;WAET,KAAK,CAAC,GAAG,EAAE,CAAC,GA7CR,KAAM,SA6CY,IAAI,CAAC,YAAW,EAAE,CAAC;;;AACtD,CAAC;AAEM,KAAK,CAAC,SAAS,aAAe,CAAC;IACpC,KAAK,CAAC,KAAK,SAAS,mBAAmB;IAEvC,KAAK,CAAC,UAAU,GAAG,GAAG,CA9CA,SAAU,UA8CG,+BAAiC;QAClE,KAAK,EAAE,KAAK,CAAC,MAAM;;IAGrB,KAAK,CAAC,OAAO,GAA0B,MAAM,CAAC,MAAM;UAE/C,KAAK,CAAC,GAAG,EAAE,UAAU,GAAK,CAAC;QAC5B,GAAG,CAAC,IAAI,GA1DG,KAAM,SA0DD,KAAK,CAAC,UAAU,EAAE,IAAI;QACtC,EAAE,EAAE,IAAI,MAAK,KAAO,GAAE,CAAC;YACrB,KAAK,CAAC,IAAI,GA5DD,KAAM,SA4DG,OAAO,CAAC,UAAU,EAAE,KAAK,CA5DlC,KAAM,SA4DkC,GAAG;YACpD,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC;QAC7B,CAAC;YAEG,CAAC;YACH,KAAK,EAAC,OAAS,GAAE,UAAU;YAC3B,KAAK,CAAC,MAAM,GAAG,YAAY,CAAC,UAAU;YACtC,KAAK,CAAC,UAAU,GAAG,MAAM,CAAC,OAAO,IAAI,MAAM;YAC3C,EAAkC,AAAlC,gCAAkC;YAElC,UAAU,CAAC,IAAI;YAEf,EAAkD,AAAlD,gDAAkD;;iBAE/C,IAAI,GAAG,UAAU;;QAEtB,CAAC,QAAQ,KAAK,EAAE,CAAC;gBArEI,QAAuB,eAsE7B,KAAK,EAAE,eAAe,EAAE,UAAU,CAAC,EAAE,EAAE,KAAK;YACzD,KAAK,EAAC,qBAAuB,GAAE,KAAK;;;QAEtC,CAAC;IACH,CAAC;IAGH,UAAU,CAAC,SAAS;WAEb,OAAO;AAChB,CAAC;QAvCY,SAAS,GAAT,SAAS;AAyCtB,KAAK,CAAC,gBAAgB,IAAI,IAAgB,EAAE,OAAY,GAAK,CAAC;IAC5D,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,OAAO;AACrC,CAAC;AAED,KAAK,CAAC,WAAW,UAAU,IAAgB,GAAK,CAAC;IAC/C,gBAAgB,CAAC,IAAI,QAAQ,SAAS;AACxC,CAAC;AAED,KAAK,CAAC,QAAQ;IACZ,MAAM;QACJ,IAAI,GAAE,kBAAoB;cACpB,MAAM,IAAmB,CAAC;iBACzB,oBAAoB;YACzB,OAAO,CAAC,GAAG,EAAC,wBAA0B;kBAChC,WAAW;iBACZ,aAAa;QACpB,CAAC;;;AAIL,KAAK,CAAC,cAAc,IAClB,IAAgB,EAChB,EAAqC,AAArC,mCAAqC;AACrC,SAAqC,GAClC,CAAC;IACJ,MAAM,CAAC,OAAO,CAAC,SAAQ,EAAE,OAAO,GAAG,OAAO,EAAE,GAAG,IAC7C,IAAI,CAAC,aAAa,CAAC,OAAO,EAAE,GAAG;;AAEnC,CAAC;AAED,EAAqC,AAArC,mCAAqC;AACrC,KAAK,CAAC,sBAAsB,IAAI,IAAS,EAAE,IAAY,GAAK,CAAC;aAClD,IAAI,GAAG,CAAC;YACX,CAAC;YACH,KAAK,CAAC,OAAO,GA7HJ,GAAI,SA6HM,YAAY,CAAC,IAAI;gBAAI,QAAQ,GAAE,IAAM;;YACxD,KAAK,CAAC,aAAa,GAAG,OAAO,CAAC,KAAK,CA7H1B,GAAI,SA6H0B,GAAG,EAAE,MAAM,EAAE,IAAI,GAAK,IAAI,CAAC,IAAI;;YACtE,IAAI,CAAC,OAAO,CAAC,IAAI,IAAI,aAAa,CAAC,OAAO;QAC5C,CAAC,QAAQ,GAAG,EAAO,CAAC;YAClB,EAAE,EAAE,GAAG,CAAC,IAAI,MAAK,MAAQ,GAAE,CAAC;gBAC1B,KAAK,CAAC,GAAG;YACX,CAAC;QACH,CAAC;IACH,CAAC;aAEQ,MAAM,GAAG,CAAC;QACjB,KAAK,CAAC,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAvIzB,GAAI,SAuIyB,GAAG;QAxIhC,GAAI,SAyIZ,cAAc,CAAC,IAAI,EAAE,YAAY;IACtC,CAAC;IAED,IAAI;IACJ,IAAI,CAAC,EAAE,EAAC,IAAM,GAAE,MAAM;AACxB,CAAC;AAED,KAAK,CAAC,YAAY,IAAI,IAAS,GAAK,CAAC;IACnC,KAAK,CAAC,uBAAuB,GA/Id,KAAM,SA+IgB,IAAI,CACvC,WAAW,GACX,sBAAwB;IAE1B,EAAE,EAAE,IAAI,CAAC,YAAY,EAAE,CAAC;QACtB,IAAI,CAAC,YAAY,CAAC,uBAAuB,MAAQ,CAAC;QAAA,CAAC;IACrD,CAAC,MAAM,CAAC;QACN,sBAAsB,CAAC,IAAI,EAAE,uBAAuB;IACtD,CAAC;AACH,CAAC;AAED,KAAK,CAAC,cAAc,UAAU,WAA6B,GAAK,CAAC;IAC/D,KAAK,EAAC,cAAgB;IACtB,KAAK,CAAC,OAAO,SAAS,SAAS;IAE/B,KAAK,EAAC,gBAAkB;IACxB,KAAK,CAAC,IAAI,GA9JA,IAAI,CA8JI,KAAK,CAAC,WAAW;IAEnC,gBAAgB,CAAC,IAAI,EAAE,OAAO;IAC9B,cAAc,CAAC,IAAI,EAAE,QAAQ;IAC7B,YAAY,CAAC,IAAI;WAEV,IAAI;AACb,CAAC;AAED,KAAK,CAAC,iBAAiB,UAAU,IAAgB,GAAK,CAAC;IACrD,KAAK,EAAC,2BAA6B;IACnC,KAAK,CAAC,QAAQ;YA7KM,SAAU,cA8KhB,mBAAmB;YAC7B,aAAa,EAAE,IAAI;WAClB,EAAE,EAAC,GAAK,OAAQ,WAAW,CAAC,IAAI;;;IAGrC,IAAI,CAAC,EAAE,EAAC,KAAO,aAAc,CAAC;QAC5B,KAAK,EAAC,8BAAgC;cAChC,WAAW,CAAC,IAAI;IACxB,CAAC;IACD,IAAI,CAAC,EAAE,EAAC,IAAM,OAAQ,QAAQ,CAAC,OAAO,EAAE,OAAO,GAAK,OAAO,CAAC,KAAK;;;AACnE,CAAC;AAED,KAAK,CAAC,OAAO,UAAU,WAA6B,GAAK,CAAC;IACxD,KAAK,CAAC,IAAI,SAAS,cAAc,CAAC,WAAW;IAC7C,IAAI,CAAC,EAAE,EAAC,IAAM,OAAQ,OAAO,CAAC,IAAI;;UAC5B,iBAAiB,CAAC,IAAI;AAC9B,CAAC;QAEQ,OAAO,GAAP,OAAO"}