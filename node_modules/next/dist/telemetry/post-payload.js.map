{"version":3,"sources":["../../telemetry/post-payload.ts"],"sourcesContent":["import retry from 'next/dist/compiled/async-retry'\nimport fetch from 'node-fetch'\nimport { EventBatchShape, EventContext, EventMeta } from './storage'\n\nexport interface Data {\n  context: EventContext\n  meta: EventMeta\n  events: EventBatchShape[]\n}\n\nexport function _postPayload(data: Data) {\n  let lines = ''\n\n  function writeField(key: string, value: unknown) {\n    if (lines[lines.length - 1] !== ' ') {\n      lines += ','\n    }\n    if (value === null || value === undefined) {\n      lines += `${key}=false`\n    } else if (typeof value === 'object') {\n      lines += `${key}=\"object\"`\n    } else if (typeof value === 'string') {\n      lines += `${key}=\"${value}\"`\n    } else {\n      lines += `${key}=${value}`\n    }\n  }\n\n  const { nextVersion: blitzVersion, ...meta } = data.meta\n\n  for (let event of data.events) {\n    // New line\n    if (lines) {\n      lines += '\\n'\n    }\n\n    // Measurement name\n    lines += event.eventName\n\n    // Add tags\n    lines += `,blitzVersion=\"${blitzVersion}\"`\n\n    // Separate tags + fields\n    lines += ' '\n\n    // Add fields\n    // from context\n    for (let [key, value] of Object.entries(data.context)) {\n      writeField(key, value)\n    }\n    // from event.fields\n    for (let [key, value] of Object.entries(event.fields)) {\n      writeField(key, value)\n    }\n    // from meta\n    for (let [key, value] of Object.entries(meta)) {\n      writeField(key, value)\n    }\n  }\n\n  return (\n    retry(\n      () =>\n        fetch(\n          `https://us-east-1-1.aws.cloud2.influxdata.com/api/v2/write?org=blitz&bucket=blitzjs`,\n          {\n            method: 'POST',\n            body: lines,\n            headers: {\n              Authorization:\n                'Token Rh3i3hTSsazb8uD4tBnosOC8-vQ38Xbu13SrqRqV5ChCpvE69mmkw7KkNZQh0yEUuS0KjTgbf0ot8PnCHGfJgw==',\n            },\n            timeout: 5000,\n          }\n        ).then(async (res) => {\n          if (!res.ok) {\n            const err = new Error(res.statusText)\n            ;(err as any).response = res\n            throw err\n          }\n        }),\n      { minTimeout: 500, retries: 1, factor: 1 }\n    )\n      .catch(() => {\n        // We swallow errors when telemetry cannot be sent\n      })\n      // Ensure promise is voided\n      .then(\n        () => {},\n        () => {}\n      )\n  )\n}\n"],"names":[],"mappings":";;;;QAUgB,YAAY,GAAZ,YAAY;AAVV,GAAgC,CAAhC,WAAgC;AAChC,GAAY,CAAZ,UAAY;;;;;;SASd,YAAY,CAAC,IAAU,EAAE,CAAC;IACxC,GAAG,CAAC,KAAK;aAEA,UAAU,CAAC,GAAW,EAAE,KAAc,EAAE,CAAC;QAChD,EAAE,EAAE,KAAK,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,OAAM,CAAG,GAAE,CAAC;YACpC,KAAK,KAAI,CAAG;QACd,CAAC;QACD,EAAE,EAAE,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;YAC1C,KAAK,OAAO,GAAG,CAAC,MAAM;QACxB,CAAC,MAAM,EAAE,SAAS,KAAK,MAAK,MAAQ,GAAE,CAAC;YACrC,KAAK,OAAO,GAAG,CAAC,SAAS;QAC3B,CAAC,MAAM,EAAE,SAAS,KAAK,MAAK,MAAQ,GAAE,CAAC;YACrC,KAAK,OAAO,GAAG,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;QAC7B,CAAC,MAAM,CAAC;YACN,KAAK,OAAO,GAAG,CAAC,CAAC,EAAE,KAAK;QAC1B,CAAC;IACH,CAAC;IAED,KAAK,GAAG,WAAW,EAAE,YAAY,MAAK,IAAI,KAAK,IAAI,CAAC,IAAI;SAEnD,GAAG,CAAC,KAAK,IAAI,IAAI,CAAC,MAAM,CAAE,CAAC;QAC9B,EAAW,AAAX,SAAW;QACX,EAAE,EAAE,KAAK,EAAE,CAAC;YACV,KAAK,KAAI,EAAI;QACf,CAAC;QAED,EAAmB,AAAnB,iBAAmB;QACnB,KAAK,IAAI,KAAK,CAAC,SAAS;QAExB,EAAW,AAAX,SAAW;QACX,KAAK,KAAK,eAAe,EAAE,YAAY,CAAC,CAAC;QAEzC,EAAyB,AAAzB,uBAAyB;QACzB,KAAK,KAAI,CAAG;QAEZ,EAAa,AAAb,WAAa;QACb,EAAe,AAAf,aAAe;aACV,GAAG,EAAE,GAAG,EAAE,KAAK,KAAK,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAG,CAAC;YACtD,UAAU,CAAC,GAAG,EAAE,KAAK;QACvB,CAAC;QACD,EAAoB,AAApB,kBAAoB;aACf,GAAG,EAAE,IAAG,EAAE,MAAK,KAAK,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,MAAM,EAAG,CAAC;YACtD,UAAU,CAAC,IAAG,EAAE,MAAK;QACvB,CAAC;QACD,EAAY,AAAZ,UAAY;aACP,GAAG,EAAE,IAAG,EAAE,MAAK,KAAK,MAAM,CAAC,OAAO,CAAC,IAAI,EAAG,CAAC;YAC9C,UAAU,CAAC,IAAG,EAAE,MAAK;QACvB,CAAC;IACH,CAAC;eA1De,WAAgC,kBAChC,UAAY,WA+DnB,mFAAmF;YAElF,MAAM,GAAE,IAAM;YACd,IAAI,EAAE,KAAK;YACX,OAAO;gBACL,aAAa,GACX,8FAAgG;;YAEpG,OAAO,EAAE,IAAI;WAEf,IAAI,QAAQ,GAAG,GAAK,CAAC;YACrB,EAAE,GAAG,GAAG,CAAC,EAAE,EAAE,CAAC;gBACZ,KAAK,CAAC,GAAG,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,UAAU;gBAClC,GAAG,CAAS,QAAQ,GAAG,GAAG;gBAC5B,KAAK,CAAC,GAAG;YACX,CAAC;QACH,CAAC;;QACD,UAAU,EAAE,GAAG;QAAE,OAAO,EAAE,CAAC;QAAE,MAAM,EAAE,CAAC;OAEvC,KAAK,KAAO,CAAC;IACZ,EAAkD,AAAlD,gDAAkD;IACpD,CAAC,CACD,EAA2B,AAA3B,yBAA2B;KAC1B,IAAI,KACG,CAAC;IAAA,CAAC,MACF,CAAC;IAAA,CAAC;AAGhB,CAAC"}