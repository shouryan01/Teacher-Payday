{"version":3,"sources":["../../client/router.ts"],"sourcesContent":["/* global window */\nimport React from 'react'\nimport Router, {\n  extractQueryFromAsPath,\n  extractRouterParams,\n} from '../shared/lib/router/router'\nimport type { NextRouter } from '../shared/lib/router/router'\nimport { RouterContext } from '../shared/lib/router-context'\n\ntype ClassArguments<T> = T extends new (...args: infer U) => any ? U : any\n\ntype RouterArgs = ClassArguments<typeof Router>\n\ntype SingletonRouterBase = {\n  router: Router | null\n  readyCallbacks: Array<() => any>\n  ready(cb: () => any): void\n}\n\nexport { Router }\n\nexport type { NextRouter }\nexport type BlitzRouter = NextRouter\n\nexport type SingletonRouter = SingletonRouterBase & NextRouter\n\nconst singletonRouter: SingletonRouterBase = {\n  router: null, // holds the actual router instance\n  readyCallbacks: [],\n  ready(cb: () => void) {\n    if (this.router) return cb()\n    if (typeof window !== 'undefined') {\n      this.readyCallbacks.push(cb)\n    }\n  },\n}\n\n// Create public properties and methods of the router in the singletonRouter\nconst urlPropertyFields = [\n  'pathname',\n  'route',\n  'query',\n  'asPath',\n  'components',\n  'isFallback',\n  'basePath',\n  'locale',\n  'locales',\n  'defaultLocale',\n  'isReady',\n  'isPreview',\n  'isLocaleDomain',\n  'domainLocales',\n]\nconst routerEvents = [\n  'routeChangeStart',\n  'beforeHistoryChange',\n  'routeChangeComplete',\n  'routeChangeError',\n  'hashChangeStart',\n  'hashChangeComplete',\n] as const\nexport type RouterEvent = typeof routerEvents[number]\n\nconst coreMethodFields = [\n  'push',\n  'replace',\n  'reload',\n  'back',\n  'prefetch',\n  'beforePopState',\n]\n\n// Events is a static property on the router, the router doesn't have to be initialized to use it\nObject.defineProperty(singletonRouter, 'events', {\n  get() {\n    return Router.events\n  },\n})\n\nurlPropertyFields.forEach((field: string) => {\n  // Here we need to use Object.defineProperty because we need to return\n  // the property assigned to the actual router\n  // The value might get changed as we change routes and this is the\n  // proper way to access it\n  Object.defineProperty(singletonRouter, field, {\n    get() {\n      const router = getRouter() as any\n      return router[field] as string\n    },\n  })\n})\n\ncoreMethodFields.forEach((field: string) => {\n  // We don't really know the types here, so we add them later instead\n  ;(singletonRouter as any)[field] = (...args: any[]) => {\n    const router = getRouter() as any\n    return router[field](...args)\n  }\n})\n\nrouterEvents.forEach((event) => {\n  singletonRouter.ready(() => {\n    Router.events.on(event, (...args) => {\n      const eventField = `on${event.charAt(0).toUpperCase()}${event.substring(\n        1\n      )}`\n      const _singletonRouter = singletonRouter as any\n      if (_singletonRouter[eventField]) {\n        try {\n          _singletonRouter[eventField](...args)\n        } catch (err) {\n          console.error(`Error when running the Router event: ${eventField}`)\n          console.error(`${err.message}\\n${err.stack}`)\n        }\n      }\n    })\n  })\n})\n\nfunction getRouter(): Router {\n  if (!singletonRouter.router) {\n    const message =\n      'No router instance found.\\n' +\n      'You should only use \"next/router\" on the client side of your app.\\n'\n    throw new Error(message)\n  }\n  return singletonRouter.router\n}\n\n// Export the singletonRouter and this is the public API.\nexport default singletonRouter as SingletonRouter\n\n// Reexport the withRoute HOC\nexport { default as withRouter } from './with-router'\n\n/**\n * `useRouter` is a React hook used to access `router` object within components\n *\n * @returns `router` object\n * @see Docs {@link https://blitzjs.com/docs/router#router-object | router}\n */\nexport function useRouter(): NextRouter {\n  return React.useContext(RouterContext)\n}\n\n// INTERNAL APIS\n// -------------\n// (do not use following exports inside the app)\n\n// Create a router and assign it as the singleton instance.\n// This is used in client side when we are initilizing the app.\n// This should **not** be used inside the server.\nexport function createRouter(...args: RouterArgs): Router {\n  singletonRouter.router = new Router(...args)\n  singletonRouter.readyCallbacks.forEach((cb) => cb())\n  singletonRouter.readyCallbacks = []\n\n  return singletonRouter.router\n}\n\n// This function is used to create the `withRouter` router instance\nexport function makePublicRouterInstance(router: Router): NextRouter {\n  const _router = router as any\n  const instance = {} as any\n\n  for (const property of urlPropertyFields) {\n    if (typeof _router[property] === 'object') {\n      instance[property] = Object.assign(\n        Array.isArray(_router[property]) ? [] : {},\n        _router[property]\n      ) // makes sure query is not stateful\n      continue\n    }\n\n    instance[property] = _router[property]\n  }\n\n  // Events is a static property on the router, the router doesn't have to be initialized to use it\n  instance.events = Router.events\n\n  coreMethodFields.forEach((field) => {\n    instance[field] = (...args: any[]) => {\n      return _router[field](...args)\n    }\n  })\n\n  return instance\n}\n\nexport function useRouterQuery() {\n  const router = useRouter()\n\n  const query = React.useMemo(() => extractQueryFromAsPath(router.asPath), [\n    router.asPath,\n  ])\n\n  return query\n}\n\ntype Dict<T> = Record<string, T | undefined>\ntype ReturnTypes = 'string' | 'number' | 'array'\n\nexport function useParams(): Dict<string | string[]>\nexport function useParams(returnType?: ReturnTypes): Dict<string | string[]>\nexport function useParams(returnType: 'string'): Dict<string>\nexport function useParams(returnType: 'number'): Dict<number>\nexport function useParams(returnType: 'array'): Dict<string[]>\n\nexport function useParams(\n  returnType?: 'string' | 'number' | 'array' | undefined\n) {\n  const router = useRouter()\n  const query = useRouterQuery()\n\n  const params = React.useMemo(() => {\n    const rawParams = extractRouterParams(router.query, query)\n\n    if (returnType === 'string') {\n      const parsedParams: Dict<string> = {}\n      for (const key in rawParams) {\n        if (typeof rawParams[key] === 'string') {\n          parsedParams[key] = rawParams[key] as string\n        }\n      }\n      return parsedParams\n    }\n\n    if (returnType === 'number') {\n      const parsedParams: Dict<number> = {}\n      for (const key in rawParams) {\n        if (rawParams[key]) {\n          const num = Number(rawParams[key])\n          parsedParams[key] = isNaN(num) ? undefined : num\n        }\n      }\n      return parsedParams\n    }\n\n    if (returnType === 'array') {\n      const parsedParams: Dict<string[]> = {}\n      for (const key in rawParams) {\n        const rawValue = rawParams[key]\n        if (Array.isArray(rawParams[key])) {\n          parsedParams[key] = rawValue as string[]\n        } else if (typeof rawValue === 'string') {\n          parsedParams[key] = [rawValue]\n        }\n      }\n      return parsedParams\n    }\n\n    return rawParams\n  }, [router.query, query, returnType])\n\n  return params\n}\n\nexport function useParam(key: string): undefined | string | string[]\nexport function useParam(key: string, returnType: 'string'): string | undefined\nexport function useParam(key: string, returnType: 'number'): number | undefined\nexport function useParam(key: string, returnType: 'array'): string[] | undefined\nexport function useParam(\n  key: string,\n  returnType?: ReturnTypes\n): undefined | number | string | string[] {\n  const params = useParams(returnType)\n  const value = params[key]\n\n  return value\n}\n"],"names":[],"mappings":"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"}