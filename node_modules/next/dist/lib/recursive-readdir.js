"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.recursiveReadDir = recursiveReadDir;
exports.recursiveFindPages = recursiveFindPages;
var _fs = require("fs");
var _path = require("path");
var _utils = require("../build/utils");
async function recursiveReadDir(dir, filter, ignore, arr = [], rootDir = dir) {
    const result = await _fs.promises.readdir(dir, {
        withFileTypes: true
    });
    await Promise.all(result.map(async (part)=>{
        const absolutePath = (0, _path).join(dir, part.name);
        if (ignore && ignore.test(part.name)) return;
        // readdir does not follow symbolic links
        // if part is a symbolic link, follow it using stat
        let isDirectory = part.isDirectory();
        if (part.isSymbolicLink()) {
            const stats = await _fs.promises.stat(absolutePath);
            isDirectory = stats.isDirectory();
        }
        if (isDirectory) {
            await recursiveReadDir(absolutePath, filter, ignore, arr, rootDir);
            return;
        }
        if (!filter.test(part.name)) {
            return;
        }
        arr.push(absolutePath.replace(rootDir, ''));
    }));
    return arr.sort();
}
async function recursiveFindPages(dir, filter, ignore, arr = [], rootDir = dir) {
    let folders = await _fs.promises.readdir(dir);
    if (dir === rootDir) {
        folders = folders.filter((folder)=>_utils.topLevelFoldersThatMayContainPages.includes(folder)
        );
    }
    await Promise.all(folders.map(async (part)=>{
        const absolutePath = (0, _path).join(dir, part);
        if (ignore && ignore.test(part)) return;
        const pathStat = await _fs.promises.stat(absolutePath);
        if (pathStat.isDirectory()) {
            await recursiveFindPages(absolutePath, filter, ignore, arr, rootDir);
            return;
        }
        if (!filter.test(part)) {
            return;
        }
        const relativeFromRoot = absolutePath.replace(rootDir, '');
        if ((0, _utils).getIsPageFile(relativeFromRoot)) {
            arr.push(relativeFromRoot);
            return;
        }
    }));
    return arr.sort();
}

//# sourceMappingURL=recursive-readdir.js.map