{"version":3,"sources":["../../stdlib/error-boundary.tsx"],"sourcesContent":["import { Router } from '../client/router'\nimport { RedirectError } from './errors'\nimport * as React from 'react'\nimport { RouterContext } from '../shared/lib/router-context'\nconst debug = require('debug')('blitz:errorboundary')\n\nconst changedArray = (a: Array<unknown> = [], b: Array<unknown> = []) =>\n  a.length !== b.length || a.some((item, index) => !Object.is(item, b[index]))\n\ninterface ErrorFallbackProps {\n  error: Error & Record<any, any>\n  resetErrorBoundary: (...args: Array<unknown>) => void\n}\n\ninterface ErrorBoundaryPropsWithComponent {\n  onResetKeysChange?: (\n    prevResetKeys: Array<unknown> | undefined,\n    resetKeys: Array<unknown> | undefined\n  ) => void\n  onReset?: (...args: Array<unknown>) => void\n  onError?: (error: Error, info: { componentStack: string }) => void\n  resetKeys?: Array<unknown>\n  fallback?: never\n  FallbackComponent: React.ComponentType<ErrorFallbackProps>\n  fallbackRender?: never\n}\n\ndeclare function FallbackRender(\n  props: ErrorFallbackProps\n): React.ReactElement<\n  unknown,\n  string | React.FunctionComponent | typeof React.Component\n> | null\n\ninterface ErrorBoundaryPropsWithRender {\n  onResetKeysChange?: (\n    prevResetKeys: Array<unknown> | undefined,\n    resetKeys: Array<unknown> | undefined\n  ) => void\n  onReset?: (...args: Array<unknown>) => void\n  onError?: (error: Error, info: { componentStack: string }) => void\n  resetKeys?: Array<unknown>\n  fallback?: never\n  FallbackComponent?: never\n  fallbackRender: typeof FallbackRender\n}\n\ninterface ErrorBoundaryPropsWithFallback {\n  onResetKeysChange?: (\n    prevResetKeys: Array<unknown> | undefined,\n    resetKeys: Array<unknown> | undefined\n  ) => void\n  onReset?: (...args: Array<unknown>) => void\n  onError?: (error: Error, info: { componentStack: string }) => void\n  resetKeys?: Array<unknown>\n  fallback: React.ReactElement<\n    unknown,\n    string | React.FunctionComponent | typeof React.Component\n  > | null\n  FallbackComponent?: never\n  fallbackRender?: never\n}\n\ntype ErrorBoundaryProps =\n  | ErrorBoundaryPropsWithFallback\n  | ErrorBoundaryPropsWithComponent\n  | ErrorBoundaryPropsWithRender\n\ntype ErrorBoundaryState = { error: Error | null }\n\nconst initialState: ErrorBoundaryState = { error: null }\n\nclass ErrorBoundary extends React.Component<\n  React.PropsWithRef<React.PropsWithChildren<ErrorBoundaryProps>>,\n  ErrorBoundaryState\n> {\n  static contextType = RouterContext\n\n  static getDerivedStateFromError(error: Error) {\n    return { error }\n  }\n\n  state = initialState\n  updatedWithError = false\n  resetErrorBoundary = (...args: Array<unknown>) => {\n    this.props.onReset?.(...args)\n    this.reset()\n  }\n\n  reset() {\n    this.updatedWithError = false\n    this.setState(initialState)\n  }\n\n  async componentDidCatch(error: Error, info: React.ErrorInfo) {\n    if (error instanceof RedirectError) {\n      debug('Redirecting from ErrorBoundary to', error.url)\n      await (this.context as Router)?.push(error.url)\n      return\n    }\n    this.props.onError?.(error, info)\n  }\n\n  componentDidMount() {\n    const { error } = this.state\n\n    if (error !== null) {\n      this.updatedWithError = true\n    }\n\n    // Automatically reset on route change\n    ;(this.context as Router)?.events?.on(\n      'routeChangeComplete',\n      this.handleRouteChange\n    )\n  }\n\n  handleRouteChange = () => {\n    debug('Resetting error boundary on route change')\n    this.props.onReset?.()\n    this.reset()\n  }\n\n  componentWillUnmount() {\n    ;(this.context as Router)?.events?.off(\n      'routeChangeComplete',\n      this.handleRouteChange\n    )\n  }\n\n  componentDidUpdate(prevProps: ErrorBoundaryProps) {\n    const { error } = this.state\n    const { resetKeys } = this.props\n\n    // There's an edge case where if the thing that triggered the error\n    // happens to *also* be in the resetKeys array, we'd end up resetting\n    // the error boundary immediately. This would likely trigger a second\n    // error to be thrown.\n    // So we make sure that we don't check the resetKeys on the first call\n    // of cDU after the error is set\n    if (error !== null && !this.updatedWithError) {\n      this.updatedWithError = true\n      return\n    }\n\n    if (error !== null && changedArray(prevProps.resetKeys, resetKeys)) {\n      this.props.onResetKeysChange?.(prevProps.resetKeys, resetKeys)\n      this.reset()\n    }\n  }\n\n  render() {\n    const { error } = this.state\n\n    const { fallbackRender, FallbackComponent, fallback } = this.props\n\n    if (error !== null) {\n      const props = {\n        error,\n        resetErrorBoundary: this.resetErrorBoundary,\n      }\n      if (error instanceof RedirectError) {\n        // Don't render children because redirect is imminent\n        return null\n      } else if (React.isValidElement(fallback)) {\n        return fallback\n      } else if (typeof fallbackRender === 'function') {\n        return fallbackRender(props)\n      } else if (FallbackComponent) {\n        return <FallbackComponent {...props} />\n      } else {\n        throw new Error(\n          '<ErrorBoundary> requires either a fallback, fallbackRender, or FallbackComponent prop'\n        )\n      }\n    }\n\n    return this.props.children\n  }\n}\n\nfunction withErrorBoundary<P>(\n  Component: React.ComponentType<P>,\n  errorBoundaryProps: ErrorBoundaryProps\n): React.ComponentType<P> {\n  const Wrapped: React.ComponentType<P> = (props) => {\n    return (\n      <ErrorBoundary {...errorBoundaryProps}>\n        <Component {...props} />\n      </ErrorBoundary>\n    )\n  }\n\n  // Format for display in DevTools\n  const name = Component.displayName || Component.name || 'Unknown'\n  Wrapped.displayName = `withErrorBoundary(${name})`\n\n  return Wrapped\n}\n\nfunction useErrorHandler(givenError?: unknown): (error: unknown) => void {\n  const [error, setError] = React.useState<unknown>(null)\n  if (givenError != null) throw givenError\n  if (error != null) throw error\n  return setError\n}\n\nexport { ErrorBoundary, withErrorBoundary, useErrorHandler }\nexport type {\n  ErrorFallbackProps,\n  ErrorBoundaryPropsWithComponent,\n  ErrorBoundaryPropsWithRender,\n  ErrorBoundaryPropsWithFallback,\n  ErrorBoundaryProps,\n}\n\n/*\neslint\n  @typescript-eslint/no-throw-literal: \"off\",\n  @typescript-eslint/prefer-nullish-coalescing: \"off\"\n*/\n"],"names":[],"mappings":"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"}