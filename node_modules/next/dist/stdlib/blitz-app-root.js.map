{"version":3,"sources":["../../stdlib/blitz-app-root.tsx"],"sourcesContent":["import {\n  getPublicDataStore,\n  useAuthorizeIf,\n  useSession,\n} from '../data-client/auth'\nimport { formatWithValidation } from '../shared/lib/utils'\nimport { Head } from '../shared/lib/head'\nimport { RedirectError } from './errors'\nimport { AppProps, BlitzPage } from '../types/index'\nimport React, { ComponentPropsWithoutRef, FC } from 'react'\nimport { Hydrate, HydrateOptions } from 'react-query/hydration'\nimport { QueryClient, QueryClientProvider } from 'react-query'\nimport { queryClient } from '../data-client/react-query-utils'\nconst debug = require('debug')('blitz:approot')\n\nexport type BlitzProviderProps = {\n  client?: QueryClient\n  contextSharing?: boolean\n  dehydratedState?: unknown\n  hydrateOptions?: HydrateOptions\n}\n\nexport const BlitzProvider: FC<BlitzProviderProps> = ({\n  client,\n  contextSharing = false,\n  dehydratedState,\n  hydrateOptions,\n  children,\n}) => {\n  return (\n    <QueryClientProvider\n      client={client ?? queryClient}\n      contextSharing={contextSharing}\n    >\n      <Hydrate state={dehydratedState} options={hydrateOptions}>\n        {children}\n      </Hydrate>\n    </QueryClientProvider>\n  )\n}\n\nconst customCSS = `\n  body::before {\n    content: \"\";\n    display: block;\n    position: fixed;\n    width: 100%;\n    height: 100%;\n    top: 0;\n    left: 0;\n    z-index: 99999;\n    background-color: white;\n  }\n\n  .blitz-first-render-complete body::before {\n    display: none;\n  }\n`\nconst noscriptCSS = `\n  body::before {\n    content: none\n  }\n`\n\nexport const NoPageFlicker = () => {\n  return (\n    <Head>\n      <style dangerouslySetInnerHTML={{ __html: customCSS }} />\n      <noscript>\n        <style dangerouslySetInnerHTML={{ __html: noscriptCSS }} />\n      </noscript>\n    </Head>\n  )\n}\n\nexport function getAuthValues(\n  Page: BlitzPage,\n  props: ComponentPropsWithoutRef<BlitzPage>\n) {\n  if (!Page) return {}\n  let authenticate = Page.authenticate\n  let redirectAuthenticatedTo = Page.redirectAuthenticatedTo\n\n  if (authenticate === undefined && redirectAuthenticatedTo === undefined) {\n    const layout = Page.getLayout?.(<Page {...props} />)\n\n    if (layout) {\n      let currentElement = layout\n      while (true) {\n        const type = layout.type\n\n        if (\n          type.authenticate !== undefined ||\n          type.redirectAuthenticatedTo !== undefined\n        ) {\n          authenticate = type.authenticate\n          redirectAuthenticatedTo = type.redirectAuthenticatedTo\n          break\n        }\n\n        if (currentElement.props?.children) {\n          currentElement = currentElement.props?.children\n        } else {\n          break\n        }\n      }\n    }\n  }\n\n  return { authenticate, redirectAuthenticatedTo }\n}\n\nexport function withBlitzInnerWrapper(Page: BlitzPage) {\n  const BlitzInnerRoot = (props: ComponentPropsWithoutRef<BlitzPage>) => {\n    // We call useSession so this will rerender anytime session changes\n    useSession({ suspense: false })\n\n    let { authenticate, redirectAuthenticatedTo } = getAuthValues(Page, props)\n\n    useAuthorizeIf(authenticate === true)\n\n    if (typeof window !== 'undefined') {\n      const publicData = getPublicDataStore().getData()\n      // We read directly from publicData.userId instead of useSession\n      // so we can access userId on first render. useSession is always empty on first render\n      if (publicData.userId) {\n        debug('[BlitzInnerRoot] logged in')\n\n        if (typeof redirectAuthenticatedTo === 'function') {\n          redirectAuthenticatedTo = redirectAuthenticatedTo({\n            session: publicData,\n          })\n        }\n\n        if (redirectAuthenticatedTo) {\n          const redirectUrl =\n            typeof redirectAuthenticatedTo === 'string'\n              ? redirectAuthenticatedTo\n              : formatWithValidation(redirectAuthenticatedTo)\n\n          debug('[BlitzInnerRoot] redirecting to', redirectUrl)\n          const error = new RedirectError(redirectUrl)\n          error.stack = null!\n          throw error\n        }\n      } else {\n        debug('[BlitzInnerRoot] logged out')\n        if (\n          authenticate &&\n          typeof authenticate === 'object' &&\n          authenticate.redirectTo\n        ) {\n          let { redirectTo } = authenticate\n          if (typeof redirectTo !== 'string') {\n            redirectTo = formatWithValidation(redirectTo)\n          }\n\n          const url = new URL(redirectTo, window.location.href)\n          url.searchParams.append('next', window.location.pathname)\n          debug('[BlitzInnerRoot] redirecting to', url.toString())\n          const error = new RedirectError(url.toString())\n          error.stack = null!\n          throw error\n        }\n      }\n    }\n\n    return <Page {...props} />\n  }\n  for (let [key, value] of Object.entries(Page)) {\n    ;(BlitzInnerRoot as any)[key] = value\n  }\n  if (process.env.NODE_ENV !== 'production') {\n    BlitzInnerRoot.displayName = `BlitzInnerRoot`\n  }\n  return BlitzInnerRoot\n}\n\nexport function BlitzWrapper({\n  children,\n  appProps,\n}: React.PropsWithChildren<{ appProps: AppProps }>) {\n  const { authenticate, redirectAuthenticatedTo } = getAuthValues(\n    appProps.Component,\n    appProps.pageProps\n  )\n\n  const noPageFlicker =\n    appProps.Component.suppressFirstRenderFlicker ||\n    authenticate !== undefined ||\n    redirectAuthenticatedTo\n\n  React.useEffect(() => {\n    setTimeout(() => {\n      document.documentElement.classList.add('blitz-first-render-complete')\n    })\n  }, [])\n\n  return (\n    <>\n      <BlitzProvider dehydratedState={appProps.pageProps?.dehydratedState}>\n        {noPageFlicker && <NoPageFlicker />}\n        {children}\n      </BlitzProvider>\n    </>\n  )\n}\n"],"names":[],"mappings":"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"}