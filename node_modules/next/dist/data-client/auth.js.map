{"version":3,"sources":["../../data-client/auth.ts"],"sourcesContent":["import { fromBase64 } from 'b64-lite'\nimport BadBehavior from 'bad-behavior'\nimport {\n  COOKIE_CSRF_TOKEN,\n  COOKIE_PUBLIC_DATA_TOKEN,\n  LOCALSTORAGE_CSRF_TOKEN,\n  LOCALSTORAGE_PREFIX,\n  LOCALSTORAGE_PUBLIC_DATA_TOKEN,\n} from './constants'\nimport {\n  deleteCookie,\n  readCookie,\n  AuthenticationError,\n  RedirectError,\n  isServer,\n  isClient,\n} from '../stdlib/index'\nimport {\n  PublicData,\n  EmptyPublicData,\n  AuthenticatedClientSession,\n  ClientSession,\n} from '../shared/lib/utils'\nimport { useEffect, useState } from 'react'\nimport { UrlObject } from 'url'\n\nfunction assert(condition: any, message: string): asserts condition {\n  if (!condition) throw new Error(message)\n}\n\nexport const parsePublicDataToken = (token: string) => {\n  assert(token, '[parsePublicDataToken] Failed: token is empty')\n\n  const publicDataStr = fromBase64(token)\n  try {\n    const publicData: PublicData = JSON.parse(publicDataStr)\n    return {\n      publicData,\n    }\n  } catch (error) {\n    throw new Error(\n      `[parsePublicDataToken] Failed to parse publicDataStr: ${publicDataStr}`\n    )\n  }\n}\n\nconst emptyPublicData: EmptyPublicData = { userId: null }\n\nclass PublicDataStore {\n  private eventKey = `${LOCALSTORAGE_PREFIX}publicDataUpdated`\n  readonly observable = BadBehavior<PublicData | EmptyPublicData>()\n\n  constructor() {\n    if (typeof window !== 'undefined') {\n      // Set default value & prevent infinite loop\n      this.updateState(undefined, { suppressEvent: true })\n      window.addEventListener('storage', (event) => {\n        if (event.key === this.eventKey) {\n          // Prevent infinite loop\n          this.updateState(undefined, { suppressEvent: true })\n        }\n      })\n    }\n  }\n\n  updateState(\n    value?: PublicData | EmptyPublicData,\n    opts?: { suppressEvent: boolean }\n  ) {\n    // We use localStorage as a message bus between tabs.\n    // Setting the current time in ms will cause other tabs to receive the `storage` event\n    if (!opts?.suppressEvent) {\n      // Prevent infinite loop\n      try {\n        localStorage.setItem(this.eventKey, Date.now().toString())\n      } catch (err) {\n        console.error('LocalStorage is not available', err)\n      }\n    }\n    this.observable.next(value ?? this.getData())\n  }\n\n  clear() {\n    deleteCookie(COOKIE_PUBLIC_DATA_TOKEN())\n    localStorage.removeItem(LOCALSTORAGE_PUBLIC_DATA_TOKEN())\n    this.updateState(emptyPublicData)\n  }\n\n  getData() {\n    const publicDataToken = this.getToken()\n    if (!publicDataToken) {\n      return emptyPublicData\n    }\n\n    const { publicData } = parsePublicDataToken(publicDataToken)\n    return publicData\n  }\n\n  private getToken() {\n    const cookieValue = readCookie(COOKIE_PUBLIC_DATA_TOKEN())\n    if (cookieValue) {\n      localStorage.setItem(LOCALSTORAGE_PUBLIC_DATA_TOKEN(), cookieValue)\n      return cookieValue\n    } else {\n      return localStorage.getItem(LOCALSTORAGE_PUBLIC_DATA_TOKEN())\n    }\n  }\n}\nexport const getPublicDataStore = (): PublicDataStore => {\n  if (!(window as any).__publicDataStore) {\n    ;(window as any).__publicDataStore = new PublicDataStore()\n  }\n  return (window as any).__publicDataStore\n}\n\nexport const getAntiCSRFToken = () => {\n  const cookieValue = readCookie(COOKIE_CSRF_TOKEN())\n  if (cookieValue) {\n    localStorage.setItem(LOCALSTORAGE_CSRF_TOKEN(), cookieValue)\n    return cookieValue\n  } else {\n    return localStorage.getItem(LOCALSTORAGE_CSRF_TOKEN())\n  }\n}\n\ninterface UseSessionOptions {\n  initialPublicData?: PublicData\n  suspense?: boolean | null\n}\n\nexport const useSession = (options: UseSessionOptions = {}): ClientSession => {\n  const suspense =\n    options?.suspense ?? Boolean(process.env.__BLITZ_SUSPENSE_ENABLED)\n\n  let initialState: ClientSession\n  if (options.initialPublicData) {\n    initialState = { ...options.initialPublicData, isLoading: false }\n  } else if (suspense) {\n    if (isServer) {\n      throw new Promise((_) => {})\n    } else {\n      initialState = { ...getPublicDataStore().getData(), isLoading: false }\n    }\n  } else {\n    initialState = { ...emptyPublicData, isLoading: true }\n  }\n\n  const [session, setSession] = useState(initialState)\n\n  useEffect(() => {\n    // Initialize on mount\n    setSession({ ...getPublicDataStore().getData(), isLoading: false })\n    const subscription = getPublicDataStore().observable.subscribe((data) =>\n      setSession({ ...data, isLoading: false })\n    )\n    return subscription.unsubscribe\n  }, [])\n\n  return session\n}\n\nexport const useAuthenticatedSession = (\n  options: UseSessionOptions = {}\n): AuthenticatedClientSession => {\n  useAuthorize()\n  return useSession(options) as AuthenticatedClientSession\n}\n\nexport const useAuthorize = () => {\n  useAuthorizeIf(true)\n}\n\nexport const useAuthorizeIf = (condition?: boolean) => {\n  if (isClient && condition && !getPublicDataStore().getData().userId) {\n    const error = new AuthenticationError()\n    error.stack = null!\n    throw error\n  }\n}\n\nexport const useRedirectAuthenticated = (to: UrlObject | string) => {\n  if (isClient && getPublicDataStore().getData().userId) {\n    const error = new RedirectError(to)\n    error.stack = null!\n    throw error\n  }\n}\n"],"names":[],"mappings":";;;;;AAA2B,GAAU,CAAV,QAAU;AACb,GAAc,CAAd,YAAc;AAO/B,GAAa,CAAb,UAAa;AAQb,GAAiB,CAAjB,MAAiB;AAOY,GAAO,CAAP,MAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;SAGlC,MAAM,CAAC,SAAc,EAAE,OAAe,EAAqB,CAAC;IACnE,EAAE,GAAG,SAAS,EAAE,KAAK,CAAC,GAAG,CAAC,KAAK,CAAC,OAAO;AACzC,CAAC;AAEM,KAAK,CAAC,oBAAoB,IAAI,KAAa,GAAK,CAAC;IACtD,MAAM,CAAC,KAAK,GAAE,6CAA+C;IAE7D,KAAK,CAAC,aAAa,OAjCM,QAAU,aAiCF,KAAK;QAClC,CAAC;QACH,KAAK,CAAC,UAAU,GAAe,IAAI,CAAC,KAAK,CAAC,aAAa;;YAErD,UAAU;;IAEd,CAAC,QAAQ,KAAK,EAAE,CAAC;QACf,KAAK,CAAC,GAAG,CAAC,KAAK,EACZ,sDAAsD,EAAE,aAAa;IAE1E,CAAC;AACH,CAAC;QAdY,oBAAoB,GAApB,oBAAoB;AAgBjC,KAAK,CAAC,eAAe;IAAsB,MAAM,EAAE,IAAI;;MAEjD,eAAe;IAiBnB,WAAW,CACT,KAAoC,EACpC,IAAiC,EACjC,CAAC;QACD,EAAqD,AAArD,mDAAqD;QACrD,EAAsF,AAAtF,oFAAsF;QACtF,EAAE,IAAG,IAAI,aAAJ,IAAI,UAAJ,CAAmB,QAAnB,CAAmB,GAAnB,IAAI,CAAE,aAAa,GAAE,CAAC;YACzB,EAAwB,AAAxB,sBAAwB;gBACpB,CAAC;gBACH,YAAY,CAAC,OAAO,MAAM,QAAQ,EAAE,IAAI,CAAC,GAAG,GAAG,QAAQ;YACzD,CAAC,QAAQ,GAAG,EAAE,CAAC;gBACb,OAAO,CAAC,KAAK,EAAC,6BAA+B,GAAE,GAAG;YACpD,CAAC;QACH,CAAC;aACI,UAAU,CAAC,IAAI,CAAC,KAAK,aAAL,KAAK,cAAL,KAAK,QAAS,OAAO;IAC5C,CAAC;IAED,KAAK,GAAG,CAAC;YAlEJ,MAAiB,mBARjB,UAAa;QA4EhB,YAAY,CAAC,UAAU,KA5EpB,UAAa;aA6EX,WAAW,CAAC,eAAe;IAClC,CAAC;IAED,OAAO,GAAG,CAAC;QACT,KAAK,CAAC,eAAe,QAAQ,QAAQ;QACrC,EAAE,GAAG,eAAe,EAAE,CAAC;mBACd,eAAe;QACxB,CAAC;QAED,KAAK,GAAG,UAAU,MAAK,oBAAoB,CAAC,eAAe;eACpD,UAAU;IACnB,CAAC;IAEO,QAAQ,GAAG,CAAC;QAClB,KAAK,CAAC,WAAW,OAnFd,MAAiB,iBARjB,UAAa;QA4FhB,EAAE,EAAE,WAAW,EAAE,CAAC;YAChB,YAAY,CAAC,OAAO,KA7FnB,UAAa,oCA6FyC,WAAW;mBAC3D,WAAW;QACpB,CAAC,MAAM,CAAC;mBACC,YAAY,CAAC,OAAO,KAhG1B,UAAa;QAiGhB,CAAC;IACH,CAAC;iBAtDa,CAAC;aAHP,QAAQ,MAzCX,UAAa,qBAyCwB,iBAAiB;aAClD,UAAU,OAjDG,YAAc;QAoDlC,EAAE,SAAS,MAAM,MAAK,SAAW,GAAE,CAAC;YAClC,EAA4C,AAA5C,0CAA4C;iBACvC,WAAW,CAAC,SAAS;gBAAI,aAAa,EAAE,IAAI;;YACjD,MAAM,CAAC,gBAAgB,EAAC,OAAS,IAAG,KAAK,GAAK,CAAC;gBAC7C,EAAE,EAAE,KAAK,CAAC,GAAG,UAAU,QAAQ,EAAE,CAAC;oBAChC,EAAwB,AAAxB,sBAAwB;yBACnB,WAAW,CAAC,SAAS;wBAAI,aAAa,EAAE,IAAI;;gBACnD,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;;AA6CI,KAAK,CAAC,kBAAkB,OAA0B,CAAC;IACxD,EAAE,GAAI,MAAM,CAAS,iBAAiB,EAAE,CAAC;QACrC,MAAM,CAAS,iBAAiB,GAAG,GAAG,CAAC,eAAe;IAC1D,CAAC;WACO,MAAM,CAAS,iBAAiB;AAC1C,CAAC;QALY,kBAAkB,GAAlB,kBAAkB;AAOxB,KAAK,CAAC,gBAAgB,OAAS,CAAC;IACrC,KAAK,CAAC,WAAW,OApGZ,MAAiB,iBARjB,UAAa;IA6GlB,EAAE,EAAE,WAAW,EAAE,CAAC;QAChB,YAAY,CAAC,OAAO,KA9GjB,UAAa,6BA8GgC,WAAW;eACpD,WAAW;IACpB,CAAC,MAAM,CAAC;eACC,YAAY,CAAC,OAAO,KAjHxB,UAAa;IAkHlB,CAAC;AACH,CAAC;QARY,gBAAgB,GAAhB,gBAAgB;AAetB,KAAK,CAAC,UAAU,IAAI,OAA0B;IAAyB,CAAC;QAE3E,GAAiB;IADnB,KAAK,CAAC,QAAQ,IACZ,GAAiB,GAAjB,OAAO,aAAP,OAAO,UAAP,CAAiB,QAAjB,CAAiB,GAAjB,OAAO,CAAE,QAAQ,cAAjB,GAAiB,cAAjB,GAAiB,GAAI,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,wBAAwB;IAEnE,GAAG,CAAC,YAAY;IAChB,EAAE,EAAE,OAAO,CAAC,iBAAiB,EAAE,CAAC;QAC9B,YAAY;WAAQ,OAAO,CAAC,iBAAiB;YAAE,SAAS,EAAE,KAAK;;IACjE,CAAC,MAAM,EAAE,EAAE,QAAQ,EAAE,CAAC;QACpB,EAAE,EA1HC,MAAiB,WA0HN,CAAC;YACb,KAAK,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC,GAAK,CAAC;YAAA,CAAC;QAC7B,CAAC,MAAM,CAAC;YACN,YAAY;eAAQ,kBAAkB,GAAG,OAAO;gBAAI,SAAS,EAAE,KAAK;;QACtE,CAAC;IACH,CAAC,MAAM,CAAC;QACN,YAAY;WAAQ,eAAe;YAAE,SAAS,EAAE,IAAI;;IACtD,CAAC;IAED,KAAK,EAAE,OAAO,EAAE,UAAU,QA5HQ,MAAO,WA4HF,YAAY;QA5HjB,MAAO,gBA8HzB,CAAC;QACf,EAAsB,AAAtB,oBAAsB;QACtB,UAAU;WAAM,kBAAkB,GAAG,OAAO;YAAI,SAAS,EAAE,KAAK;;QAChE,KAAK,CAAC,YAAY,GAAG,kBAAkB,GAAG,UAAU,CAAC,SAAS,EAAE,IAAI,GAClE,UAAU;eAAM,IAAI;gBAAE,SAAS,EAAE,KAAK;;;eAEjC,YAAY,CAAC,WAAW;IACjC,CAAC;WAEM,OAAO;AAChB,CAAC;QA7BY,UAAU,GAAV,UAAU;AA+BhB,KAAK,CAAC,uBAAuB,IAClC,OAA0B;IACK,CAAC;IAChC,YAAY;WACL,UAAU,CAAC,OAAO;AAC3B,CAAC;QALY,uBAAuB,GAAvB,uBAAuB;AAO7B,KAAK,CAAC,YAAY,OAAS,CAAC;IACjC,cAAc,CAAC,IAAI;AACrB,CAAC;QAFY,YAAY,GAAZ,YAAY;AAIlB,KAAK,CAAC,cAAc,IAAI,SAAmB,GAAK,CAAC;IACtD,EAAE,EA7JG,MAAiB,aA6JN,SAAS,KAAK,kBAAkB,GAAG,OAAO,GAAG,MAAM,EAAE,CAAC;QACpE,KAAK,CAAC,KAAK,GAAG,GAAG,CA9Jd,MAAiB;QA+JpB,KAAK,CAAC,KAAK,GAAG,IAAI;QAClB,KAAK,CAAC,KAAK;IACb,CAAC;AACH,CAAC;QANY,cAAc,GAAd,cAAc;AAQpB,KAAK,CAAC,wBAAwB,IAAI,EAAsB,GAAK,CAAC;IACnE,EAAE,EArKG,MAAiB,aAqKN,kBAAkB,GAAG,OAAO,GAAG,MAAM,EAAE,CAAC;QACtD,KAAK,CAAC,KAAK,GAAG,GAAG,CAtKd,MAAiB,eAsKY,EAAE;QAClC,KAAK,CAAC,KAAK,GAAG,IAAI;QAClB,KAAK,CAAC,KAAK;IACb,CAAC;AACH,CAAC;QANY,wBAAwB,GAAxB,wBAAwB"}