{"version":3,"sources":["../../../../build/babel/plugins/fix-node-file-trace.ts"],"sourcesContent":["import type { NodePath, PluginObj } from 'next/dist/compiled/babel/core'\nimport { addNamed as addNamedImport } from '@babel/helper-module-imports'\nimport {\n  callExpression,\n  ExportNamedDeclaration,\n  Expression,\n  FunctionDeclaration,\n  functionExpression,\n  isExportDefaultDeclaration,\n  isExportNamedDeclaration,\n  isFunctionDeclaration,\n  isIdentifier,\n  isVariableDeclaration,\n  variableDeclaration,\n  variableDeclarator,\n} from '@babel/types'\nimport * as nodePath from 'path'\nimport { getFileName, wrapExportDefaultDeclaration } from './utils'\n\nfunction functionDeclarationToExpression(declaration: FunctionDeclaration) {\n  return functionExpression(\n    declaration.id,\n    declaration.params,\n    declaration.body,\n    declaration.generator,\n    declaration.async\n  )\n}\n\nconst functionsToReplace = ['getServerSideProps', 'getStaticProps']\n\nfunction transformPropGetters(\n  path: NodePath<ExportNamedDeclaration>,\n  transform: (v: Expression) => Expression\n) {\n  const { node } = path\n\n  if (isFunctionDeclaration(node.declaration)) {\n    const { id: functionId } = node.declaration\n    if (!functionId) {\n      return\n    }\n\n    if (!functionsToReplace.includes(functionId.name)) {\n      return\n    }\n\n    node.declaration = variableDeclaration('const', [\n      variableDeclarator(\n        functionId,\n        transform(functionDeclarationToExpression(node.declaration))\n      ),\n    ])\n\n    return\n  }\n\n  if (isVariableDeclaration(node.declaration)) {\n    node.declaration.declarations.forEach((declaration) => {\n      if (\n        isIdentifier(declaration.id) &&\n        functionsToReplace.includes(declaration.id.name) &&\n        declaration.init\n      ) {\n        declaration.init = transform(declaration.init)\n      }\n    })\n  }\n}\n\nconst HOFName = 'withFixNodeFileTrace'\nconst importFrom = 'next/dist/server/utils'\n\nfunction addWithFixNodeFileTraceImport(path: NodePath<any>) {\n  return addNamedImport(path, HOFName, importFrom)\n}\n\nconst pagesToSkip = ([] as string[]).concat(\n  ...['_app', '_document', '_error'].map((name) => [\n    name + '.js',\n    name + '.jsx',\n    name + '.ts',\n    name + '.tsx',\n  ])\n)\n\nfunction isPage(filePath: string) {\n  if (!filePath.includes(nodePath.sep + 'pages' + nodePath.sep)) {\n    return false\n  }\n  if (\n    filePath.includes(\n      nodePath.sep + 'pages' + nodePath.sep + 'api' + nodePath.sep\n    )\n  ) {\n    return false\n  }\n  return !pagesToSkip.some((fileToSkip) => filePath.includes(fileToSkip))\n}\n\nfunction isApiRoute(filePath: string) {\n  if (filePath.includes(nodePath.sep + 'api' + nodePath.sep)) {\n    return true\n  }\n  return false\n}\n\nfunction FixNodeFileTrace(): PluginObj {\n  return {\n    name: 'FixNodeFileTrace',\n    visitor: {\n      Program(path, state) {\n        const filePath =\n          getFileName(state) ?? nodePath.join('pages', 'Default.js')\n\n        if (isPage(filePath)) {\n          const body = path.get('body')\n          body\n            .filter((node) => isExportNamedDeclaration(node))\n            .forEach((node) => {\n              transformPropGetters(\n                node as NodePath<ExportNamedDeclaration>,\n                (decl) => {\n                  return callExpression(addWithFixNodeFileTraceImport(node), [\n                    decl,\n                  ])\n                }\n              )\n            })\n          return\n        } else if (isApiRoute(filePath)) {\n          const body = path.get('body')\n          const exportDefaultDeclaration = body.find((node) =>\n            isExportDefaultDeclaration(node)\n          )\n          if (exportDefaultDeclaration) {\n            wrapExportDefaultDeclaration(\n              exportDefaultDeclaration,\n              HOFName,\n              importFrom\n            )\n            return\n          }\n        }\n      },\n    },\n  }\n}\n\n// eslint-disable-next-line import/no-default-export\nexport default FixNodeFileTrace\n"],"names":[],"mappings":"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"}