{"version":3,"sources":["../../../../build/babel/plugins/blitz-rpc-server-transform.ts"],"sourcesContent":["/* @eslint-disable no-redeclare */\nimport { NodePath, PluginObj, types as t } from 'next/dist/compiled/babel/core'\nimport { BabelType } from 'babel-plugin-tester'\n// @ts-ignore\nimport { addNamed as addNamedImport } from '@babel/helper-module-imports'\nimport {\n  convertPageFilePathToRoutePath,\n  convertPageFilePathToResolverName,\n  convertPageFilePathToResolverType,\n} from '../../utils'\n\n/* This plugin changes the file default export to be like this:\n *\n export default require('next/data-client').buildRpcResolver(\n   function getUsers(input) {\n     return db.users.findMany()\n   },\n   {\n    \"resolverName\": \"getUsers\",\n    \"resolverType\": \"query\",\n    \"routePath\": \"/api/rpc/getUsers\"\n  }\n  );\n *\n*/\n\nfunction functionDeclarationToExpression(declaration: t.FunctionDeclaration) {\n  return t.functionExpression(\n    declaration.id,\n    declaration.params,\n    declaration.body,\n    declaration.generator,\n    declaration.async\n  )\n}\n\nfunction classDeclarationToExpression(declaration: t.ClassDeclaration) {\n  return t.classExpression(\n    declaration.id,\n    declaration.superClass,\n    declaration.body,\n    declaration.decorators\n  )\n}\n\nfunction addBuildRpcResolverImport(path: NodePath<any>) {\n  return addNamedImport(path, 'buildRpcResolver', 'next/data-client')\n}\n\nfunction wrapInHOF(\n  path: NodePath<any>,\n  expr: t.Expression,\n  { routePath, resolverName, resolverType }: Metadata\n): t.Expression {\n  const program = path.findParent(t.isProgram) as NodePath<t.Program>\n  if (!program) throw new Error('Missing parent')\n  // eslint-disable-next-line no-shadow\n  const hasMiddlewareExport = program.node.body.find((path) => {\n    if (!t.isExportNamedDeclaration(path)) return null\n    if (!path.declaration) return null\n    if (!t.isVariableDeclaration(path.declaration)) return null\n    // eslint-disable-next-line no-shadow\n    const variableDeclarator = path.declaration.declarations.find((path) =>\n      t.isVariableDeclarator(path)\n    )\n    if (!variableDeclarator) return null\n    return (variableDeclarator.id as any).name === 'middleware'\n  })\n\n  const metadataProperties = [\n    t.objectProperty(\n      t.stringLiteral('resolverName'),\n      t.stringLiteral(resolverName)\n    ),\n    t.objectProperty(\n      t.stringLiteral('resolverType'),\n      t.stringLiteral(resolverType)\n    ),\n    t.objectProperty(t.stringLiteral('routePath'), t.stringLiteral(routePath)),\n  ]\n  if (hasMiddlewareExport) {\n    metadataProperties.push(\n      t.objectProperty(t.identifier('middleware'), t.identifier('middleware'))\n    )\n  }\n  return t.callExpression(addBuildRpcResolverImport(path), [\n    expr,\n    t.objectExpression(metadataProperties),\n  ])\n}\n\nfunction wrapExportDefaultDeclaration(path: NodePath<any>, metadata: Metadata) {\n  const { node } = path\n\n  if (\n    t.isIdentifier(node.declaration) ||\n    t.isFunctionExpression(node.declaration) ||\n    t.isCallExpression(node.declaration)\n  ) {\n    node.declaration = wrapInHOF(path, node.declaration, metadata)\n  } else if (\n    t.isFunctionDeclaration(node.declaration) ||\n    t.isClassDeclaration(node.declaration)\n  ) {\n    if (node.declaration.id) {\n      path.insertBefore(node.declaration)\n      node.declaration = wrapInHOF(path, node.declaration.id, metadata)\n    } else {\n      if (t.isFunctionDeclaration(node.declaration)) {\n        node.declaration = wrapInHOF(\n          path,\n          functionDeclarationToExpression(node.declaration),\n          metadata\n        )\n      } else {\n        node.declaration = wrapInHOF(\n          path,\n          classDeclarationToExpression(node.declaration),\n          metadata\n        )\n      }\n    }\n  }\n}\n\ninterface Metadata {\n  routePath: string\n  resolverName: string\n  resolverType: string\n}\n\nconst fileExtensionRegex = /\\.([a-z]+)$/\n\nexport default function blitzRpcServerTransform(_babel: BabelType): PluginObj {\n  return {\n    visitor: {\n      ExportDefaultDeclaration(path, state) {\n        const { filename, cwd } = state\n        const fileExt = fileExtensionRegex.exec(filename)?.[1] || 'unknown'\n\n        const relativePathFromRoot = filename.replace(cwd, '')\n        const resolverName = convertPageFilePathToResolverName(\n          relativePathFromRoot\n        )\n        const resolverType = convertPageFilePathToResolverType(\n          relativePathFromRoot\n        )\n        const routePath = convertPageFilePathToRoutePath(relativePathFromRoot, [\n          fileExt as string,\n        ])\n\n        wrapExportDefaultDeclaration(path, {\n          resolverName,\n          resolverType,\n          routePath,\n        })\n      },\n    },\n  }\n}\n"],"names":[],"mappings":"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"}